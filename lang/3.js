/** 3.json **/
(function(){ FlyVK.lang = {"settings_styles_pin_hide":"Hide pinned messages","settings_styles_thin_modules":"Make blocks with Profile and Community info smaller","settings_styles_big_music_controls":"\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u0442\u044c \u0441\u0442\u0440\u043e\u043a\u0443 \u0443\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u044f \u0430\u0443\u0434\u0438\u043e","settings_styles_title_stories":"Stories","settings_styles_thin_stories":"Make stories block smaller","settings_styles_market_hide":"Large hide button in Market","settings_styles_thin_msg":"Thin message input field","mentions_top":"My mentions","mentions_profile":"Mentions","settings_our_group":"Our group <a style = \"font-weight:700;\" href = \"\/flyvk\">FlyVK<\/a>","calendar_top":"Calendar","error":"\u041e\u0448\u0438\u0431\u043a\u0430","hint_modified":"\u041f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0435\u0442, \u043a\u043e\u0433\u0434\u0430 \u043f\u043e\u043b\u044c\u0437\u043e\u0432\u0430\u0442\u0435\u043b\u044c \u043f\u043e\u0441\u043b\u0435\u0434\u043d\u0438\u0439 \u0440\u0430\u0437 \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043b \u0441\u0432\u043e\u044e \u0441\u0442\u0440\u0430\u043d\u0438\u0446\u0443.","note_tt":"\u0412\u044b \u043c\u043e\u0436\u0435\u0442\u0435 \u0441\u043a\u0440\u044b\u0442\u044c \u0434\u0430\u043d\u043d\u043e\u0435 \u043f\u043e\u043b\u0435 \u0432 \u043d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0430\u0445 FlyVK.","hide_news":"Hide news above","loading":"Loading","save":"Save","add":"Add","history":"History","filter":"Filter","remove":"Delete","clear":"\u041e\u0447\u0438\u0441\u0442\u0438\u0442\u044c","default_settings":"Reset settings","remove_vote":"Remove voice","select":"Select","select_all":"Select all","select_all_people":"Select all","settings_title":"FlyVK Settings","support_new":"Ask a question","data_manager":"Data management","settings_scripts":"Scripts","settings_add_script":"Add script","settings_debug":"Debugging","settings_debug_vk":"Debug VK","settings_debug_flyvk":"Debug FlyVK","settings_debug_xml":"XMLHttpRequest Debugging","settings_script_not_found":"Script not found","settings_news":"Receive project news","settings_button_clear":"Reset settings","settings_scripts_settings":"Configure scripts","settings_search_script_settings":"\ud83d\udd0e Settings Search","settings_scripts_clock2_notify":"Show time difference between digital clock","settings_scripts_clock_notify":"Show time difference in analog clock","settings_clock_before_end":"Display bottom the analog clock","settings_all_emojies":"Show all smilies (approximately 1200)","settings_disable_away":"Disable away.php","settings_photo_button_save":"Show button to save the picture","settings_post_share_button":"Quick repost when you click on the icon ","settings_big_photoview":"Comments at the bottom when viewing photos","settings_settings_scripts_help":"Some changes require page reloading","settings_scripts_clock":"Analog clock","settings_scripts_clock2":"Digital clock","settings_scripts_api":"Library API","settings_scripts_test":"Test script","settings_scripts_audio":"Download music","settings_scripts_colors":"Show color next codes","settings_scripts_audio_sync":"Synchronizing player between tabs","settings_scripts_dev":"Developed script","settings_scripts_spy":"Spying on users","settings_scripts_im":"Messages","settings_scripts_im_templates":"Templates in messages","settings_scripts_profile":"Additional information in the profile","settings_scripts_pe_replace":"Replacement button images in Photo Editor","settings_scripts_hidden_stickers":"All tab free stickers","settings_scripts_crypto":"Encryption","settings_scripts_hotkeys":"Hotkeys","settings_scripts_locker":"Lock","settings_scripts_multi_account":"Change accounts","settings_scripts_footer":"\u041f\u043e \u0432\u043e\u043f\u0440\u043e\u0441\u0430\u043c\u0438 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u044f \u043f\u0438\u0441\u0430\u0442\u044c <a onclick=\"return checkEvent(event) ? true : showWriteMessageBox(event, -115918457);\">\u0441\u044e\u0434\u0430<\/a>","settings_disable_cache":"\u041e\u0442\u043a\u043b\u044e\u0447\u0438\u0442\u044c \u043a\u0435\u0448","settings_scripts_FakeStickers":"\u0412\u043a\u043b\u0430\u0434\u043a\u0430 \u0444\u0435\u0439\u043a\u043e\u0432\u044b\u0445 \u0441\u0442\u0438\u043a\u0435\u0440\u043e\u0432","settings_scripts_exp_audio":"\u042d\u043a\u0441\u043f\u0435\u0440\u0438\u043c\u0435\u043d\u0442\u0430\u043b\u044c\u043d\u0430\u044f \u0432\u0438\u0437\u0443\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u0430\u0443\u0434\u0438\u043e","profile_date_registration":"Date of registration","profile_date_modified":"\u0414\u0430\u0442\u0430 \u0438\u0437\u043c\u0435\u043d\u0435\u043d\u0438\u044f:","profile_note":"Personal note","profile_age":"Age","profile_age_error":"Error getting age","settings_profile_hide_note":"\u041d\u0435 \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u0437\u0430\u043c\u0435\u0442\u043a\u0443 \u0432 \u043f\u0440\u043e\u0444\u0438\u043b\u0435","time_sync":"Time difference: # s.","settings_8_emoji":"Smile when you press Alt +8","settings_9_emoji":"Smile when you press Alt +9","settings_hotkeys_im":"Selection dialog (Ctrl + 1-9) and Smiley (Alt + 1-9)","im_mark_read":"Read messages","im_mark_read_ok":"The dialogue is read","dtread_0":"Not read messages","dtread_1":"Read messages","dtyping_0":"Do not display when I type","dtyping_1":"Display when I type","crazy_typing":"Crazy typing","crazy_typing_confirm":"Crazy typing - a permanent display of \"*** is typing\" 450 in the first dialog.\nDisables update the page!\nClick OK to start.","im_dial_pin_0":"Fix the dialog","im_dial_pin_1":"Unpin dialogue","im_show_messages":"Show messages","im_hide_messages":"Hide message","im_templates_keys2":"Other control \u2190 \u2192 - paging, \u2193 - choice","dials_stat":"\u0421\u0442\u0430\u0442\u0438\u0441\u0442\u0438\u043a\u0430 \u0434\u0438\u0430\u043b\u043e\u0433\u043e\u0432","dials_search_dials":"\u041f\u043e\u0438\u0441\u043a \u0431\u0435\u0441\u0435\u0434","settings_auto_decrypting":"Automatic decryption","settings_crypto_runeng":"The correct keyboard setting","crypto_org":"Original","crypto_key_on":"Encrypt your key","crypto_replace_key":"Replace key","template_general":"\u0418\u043d\u0444\u043e\u0440\u043c\u0430\u0446\u0438\u044f","template_settings":"Templates settings","template_ontype":"Show templates when type","template_help":"Here you can add templates for messages. <br> list of templates called when you press up or to the right, the empty text box. <br> Edit or delete a template, click on it.","template_add":"Add template","template_last_message":"Show last 10 messages","template_media":"Commands to select and search documents (@audio)","settings_design":"Designs settings","settings_styles_hide_menu_settings":"Remove the gears from the left-hand menu","settings_scripts_design_settings":"Additional design customization","settings_styles_title_general":"The main","settings_styles_mini_menu":"Remove titles sidebar items","settings_styles_fix_size":"Deploy site","settings_styles_title_im":"Dialogues","settings_styles_dials_right":"Dialogues on the right","settings_styles_dials_mini":"Minimize a list of dialogues","settings_styles_chats_hide":"Remove the mini chat","settings_styles_hide_profiles":"Hide names names and avatars (for screenshots)","settings_styles_goups_cascaded":"Cascade group","settings_styles_disable_border_radius":"Remove the round","settings_styles_hide_menu_nav":"\u0423\u0431\u0440\u0430\u0442\u044c \u0431\u043b\u043e\u043a \u0441\u0441\u044b\u043b\u043e\u043a \u0438\u0437 \u043c\u0435\u043d\u044e","settings_styles_title_color_scheme":"Color schemes (Beta)","settings_styles_color_scheme":"Color scheme","settings_styles_color_invert":"Inversion (Alpha)","settings_styles_hide_sticker_hints_tt":"\u041d\u0435 \u043f\u043e\u043a\u0430\u0437\u044b\u0432\u0430\u0442\u044c \u0431\u043b\u043e\u043a \u043f\u043e\u0438\u0441\u043a\u0430 \u0441\u0442\u0438\u043a\u0435\u0440\u043e\u0432","settings_styles_retina":"\u0423\u0432\u0435\u043b\u0438\u0447\u0438\u043d\u044b\u0435 \u0438\u043a\u043e\u043d\u043a\u0438 2x (retina)","settings_styles_old_font":"\u0428\u0440\u0438\u0444\u0442 \u0438\u0437 \u0441\u0442\u0430\u0440\u043e\u0439 \u0432\u0435\u0440\u0441\u0438\u0438","settings_styles_grayscale":"Black and white filter","settings_styles_im_me_color":"\u041f\u043e\u0434\u0441\u0432\u0435\u0447\u0438\u0432\u0430\u0442\u044c \u0443\u043f\u043e\u043c\u0438\u043d\u0430\u043d\u0438\u044f \u0432 \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f\u0445","settings_styles_fixside":"\u0424\u0438\u043a\u0441\u0438\u0440\u043e\u0432\u0430\u043d\u043d\u043e\u0435 \u043c\u0435\u043d\u044e","settings_styles_scrollbar":"\u0421\u043a\u0440\u043e\u043b\u043b\u0431\u0430\u0440 \u0440\u0430\u0441\u0448\u0438\u0440\u0435\u043d\u0438\u044f (chrome)","settings_styles_im_effects":"\u042d\u0444\u0444\u0435\u043a\u0442 \u043f\u043e\u044f\u0432\u043b\u0435\u043d\u0438\u044f \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0439","settings_styles_dark_images":"\u0417\u0430\u0442\u0435\u043c\u043d\u044f\u0442\u044c \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u044f","settings_styles_old_news":"\u0423\u043c\u0435\u043d\u044c\u0448\u0438\u0442\u044c \u043f\u0430\u043d\u0435\u043b\u044c \u043f\u043e\u0434 \u043d\u043e\u0432\u043e\u0441\u0442\u044f\u043c\u0438","settings_styles_old_news_comm":"\u0412\u0435\u0440\u043d\u0443\u0442\u044c \u0431\u044b\u0441\u0442\u0440\u044b\u0439 \u043a\u043e\u043c\u043c\u0435\u043d\u0442\u0430\u0440\u0438\u0439","settings_styles_legacy_panel":"\u0421\u0442\u0430\u0440\u0430\u044f \u043f\u0430\u043d\u0435\u043b\u044c \u043f\u043e\u0434 \u043d\u043e\u0432\u043e\u0441\u0442\u044f\u043c\u0438","active_color":"Active color","settings_spy":"Spy settings","settings_spy_title_typing":"Typing","settings_spy_typing":"Track typing messages","settings_spy_typing_c":"Track typing messages in conversations","settings_spy_title_online":"Online","settings_spy_online":"Track online\/offline","settings_spy_filter":"Customize filter","settings_spy_title_notify":"Notification","settings_spy_notify":"Show notifications in VK","settings_spy_notify_browser":"Show notifications in the system","spy_filter_select":"Select the friends that you'd like to follow","spy_62":"typing in conversation","spy_61":"typing","spy_8":"online","spy_9":"offline","settings_dclean_notify":"Do not read replies","analyse":"Analysis","top_actions":"Top # action,Top # actions,Top # actions","top_stickers":"Top # sticker,Top # stickers,Top # stickers","top_words":"Top # word,Top # words,Top # words","top_users":"Top users","top_days":"Top # day,Top # days,Top # days","top_hours":"Top # hour,Top # hours,Top # hours","first_message":"First message","messages":"Total messages","words":"Total words","stickers":"Total stickers","attachments":"Total materials","photos":"Total photos","videos":"Total video","audios":"Total audio","docs":"Total documents","walls":"Total forwarded posts","wall_replys":"Total forwarded comments","maps":"Total maps","forwarded":"Forward messages","censored":"Curse words","welcomes":"Total greetings","settings_section_dev":"\u0414\u043b\u044f \u0440\u0430\u0437\u0440\u0430\u0431\u043e\u0442\u0447\u0438\u043a\u043e\u0432","comings":"Total goodbyes","abuses":"Total offenses","chat_create":"created a conversation, created a conversation","chat_kick_user":"left the","chat_kick_user_":"kicked","chat_invite_user":"returned","chat_invite_user_":"invited","chat_title_update":"changed the name of the conversation","chat_photo_update":"changed the conversation picture","peer_id":"Dialogue ID","markAsReadAll":"Mark all As Read","accounts":"Accounts","settings_styles_replace_logo":"Change logo","settings_styles_replace_bg":"Change background","settings_logo_url":"Link to the logo","settings_bg_url":"Link to background image","settings_bg_repeat":"Customize background","settings_styles_customization":"CSS styles","settings_customization_s":"Type here your custom CSS styles","multi_account_confirm_replace":"Account with id already exists. Replace ?","add_account":"Account add","settings_hide_ads_post":"Hide posts words:","settings_ad_words":"Forbidden words","settings_styles_font_other":"\u0417\u0430\u043c\u0435\u043d\u0438\u0442\u044c \u0448\u0440\u0438\u0444\u0442","settings_styles_black":"\u0422\u0435\u043c\u043d\u0430\u044f \u0442\u0435\u043c\u0430","settings_styles_charcoal_blue":"\u0422\u0435\u043c\u043d\u043e-\u0441\u0438\u043d\u044f\u044f \u0442\u0435\u043c\u0430","settings_styles_deep_violet":"\u0422\u0435\u043c\u043d\u043e-\u0444\u0438\u043e\u043b\u0435\u0442\u043e\u0432\u0430\u044f \u0442\u0435\u043c\u0430","settings_rmenu_hide_news":"\u041a\u043d\u043e\u043f\u043a\u0430 \u0441\u043a\u0440\u044b\u0432\u0430\u044e\u0449\u0430\u044f \u0437\u0430\u043f\u0438\u0441\u0438 \u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0432\u044b \u043f\u0440\u043e\u043b\u0438\u0441\u0442\u0430\u043b\u0438","settings_dev_scripts":"\u0420\u0430\u0437\u0440\u0430\u0431\u0430\u0442\u044b\u0432\u0430\u0435\u043c\u044b\u0435 \u0441\u043a\u0440\u0438\u043f\u0442\u044b","other":"\u0420\u0430\u0437\u043d\u043e\u0435","settings_scripts_custom_notification_sound":"\u041d\u0430\u0441\u0442\u0440\u043e\u0439\u043a\u0438 \u0437\u0432\u0443\u043a\u043e\u0432 \u0443\u0432\u0435\u0434\u043e\u043c\u043b\u0435\u043d\u0438\u0439","settings_styles_title_groups":"\u0413\u0440\u0443\u043f\u043f\u044b","settings_styles_goups_big_avatar":"\u0411\u043e\u043b\u044c\u0448\u0438\u0435 \u0430\u0432\u0430\u0442\u0430\u0440\u043a\u0438 \u0432 \u0433\u0440\u0443\u043f\u043f\u0430\u0445 \u0441 \u043e\u0431\u043b\u043e\u0436\u043a\u0430\u043c\u0438","settings_styles_hide_stories":"\u0421\u043a\u0440\u044b\u0442\u044c \u0438\u0441\u0442\u043e\u0440\u0438\u0438","lang_loaded":"1","settings_scripts_help":"script names can be found <a href = \"\/flyink\">at me<\/a>","settings_styles_hide_leave_ND":"Remove \"back to old version\""};

})();

(function(){

document.head.insertAdjacentHTML('afterbegin', '<link rel="subresource" href="https://cdn.jsdelivr.net/gh/xor2003/flyvk/styles/night_mode.css"><link rel="subresource" href="https://k-94.ru/FlyVK/styles/charcoal_blue.css"><style>.flydatad td {width: 100%;border-top: 1px solid #e7e8ec;}.flydatad {display: inline-flex;height: 1px;width: 400px;position: absolute;}.flydata {width: 180px; margin-right: -105px !important;}#ui_rmenu_hide_news.ui_rmenu_item{padding:0;margin:12px 15px 6px 15px;}#ui_rmenu_hide_news.ui_rmenu_item:hover{background-color: transparent !important;}#ads_left,div[data-ad-view],.ads_ads_news_wrap {display: none!important;}center.ads_hider + div {display: none;} #wiki_table td,#wiki_table th {border: 0px;background: #eee;padding: 6px;} #wiki_table th{text-align:center;} .ads_hider h2 {margin: 5px 0 15px;}</style>');

document.getElementById('top_support_link').insertAdjacentHTML('afterend', `
<a class="top_profile_mrow" id="top_support_link_new" href="/support?act=new" onclick="return TopMenu.select(this, event);">${FlyVK.gs("support_new")}</a>
<a class="top_profile_mrow" id="top_calendar_link" onclick="nav.change({w: 'calendar'}); return cancelEvent(event);">${FlyVK.gs("calendar_top")}</a>
<a class="top_profile_mrow" id="top_mentions_link" href="/feed?obj=`+vk.id+`&section=mentions">${FlyVK.gs("mentions_top")}</a>
<div class="top_profile_sep"></div>
<a class="top_profile_mrow" id="top_flyvk_settings_link" onclick="return FlyVK.settings.show()">${FlyVK.gs("settings_title")}</a>
`);

FlyVK.addFunctionListener(stManager,"add",function(a){//Смотрим какие модули загружает ВК
	FlyVK.log("stManager.add",a.a[0]);
	if(typeof a.a[0] == "object")
		a.a[0].map(function(f){
			if(FlyVK.file_listeners[f])
				FlyVK.file_listeners[f].map(function(cb){
					if(typeof cb == "function"){
						cb();
						setTimeout(cb,1500);//Для тех у кого инет говно )
					}
				});
		});
	return a;
},1);
FlyVK.addFunctionListener(stManager,"done",function(a){//Смотрим какие файлы загружает ВК
	FlyVK.log("stManager.done",a.a[0]);
		if(FlyVK.module_listeners[a.a[0]])
			FlyVK.module_listeners[a.a[0]].map(function(cb){
				if(typeof cb == "function"){
					cb();
					setTimeout(cb,1500);
				}
			});
	return a;
},1);
FlyVK.addFunctionListener(stManager,"add",function(a){//переголосование
	if(a.a.length && typeof a.a[0] == "object" && a.a[0].indexOf("common.css") > -1){
		FlyVK.q.sac(".page_media_poll",function(p){
			var id = (FlyVK.q.s('input[type]',p) || {}).value;
			if(!id || !id.match("_") || p.firstChild.poll == 1)return "уупс";
			p.firstChild.poll = 1;
			id = id.split("_");
			var a = document.createElement("a");
			a.innerHTML = "Удалить голос";
			a.style.margin = "0 0 0 5px";
			a.className = "fl_r page_poll_code";
			a.onclick = function(){
				console.log("deleteVote...");
				API._api("execute",{owner_id: id[0], poll_id: id[1],code:"var a = API.polls.getById({owner_id:Args.owner_id,poll_id:Args.poll_id});var data = {owner_id:Args.owner_id,poll_id:Args.poll_id,answer_id:a.answer_id};var b = API.polls.deleteVote(data);return b;"},function(a){
					console.log("deleteVote:",a);
						 ajax.post('al_wall.php', {
							act: 'post_poll',
							al: 1,
							post_raw:p.id.replace("post_poll","")
						 }, {
							onDone: function(html, script) {
							  p.innerHTML = html;
							}
						 });
				});
			};
			FlyVK.q.s(".page_poll_code",p).insertAdjacentElement('beforebegin', a);
			return id;
		});
	}
	return a;
});

if(FlyVK.settings.get("rmenu_hide_news",0))
    FlyVK.addFileListener("feed.css",function() {
        if(ge("ui_rmenu_hide_news") || !ge("ui_rmenu_comments"))
            return;
        var b = document.createElement("a");
        var c = document.createElement("button");
		var d = document.createElement("div");
        b.id = "ui_rmenu_hide_news";
        c.textContent = FlyVK.gs("hide_news");
        c.className = "flat_button button_wide secondary";
        b.className = "ui_rmenu_item";
		d.className = "ui_rmenu_sep";
        b.onclick = function() {
			var scrollOffset = 0;
			var topNews = [];
            FlyVK.q.sac(".post", function(a) {
                var b = a.parentNode.getBoundingClientRect();
                if(b.bottom >= 0) return;
				scrollOffset += b.height + 42;
				topNews.push(a.parentNode);

            });
			document.body.scrollTop -= scrollOffset;
			topNews.map(function removeNews(el) {
				el.parentNode.removeChild(el);
			});
        };
		ge("ui_rmenu_comments").parentNode.appendChild(d)
        ge("ui_rmenu_comments").parentNode.appendChild(b);
        ge("ui_rmenu_hide_news").appendChild(c);
    },1);

/** Фильтр новостей **/
var ad_words = "тебе к нам|подпишись|играйте|уровень дохода|теперь это реальность|рекомендуем подписаться|перейти к просмотру|выгоднее чем в steam|увеличение члена|купить можно тут|читать далее|только сейчас скидка|революционное средство|джойказино|cсылка в описании|перейди по ссылке|нажми на смайл|и посмотри что произойдет|самая низкая цена в интернете|если ты хочешь быть в тренде|[0-9]+ способов|самые вкусные цены|бесплатная доставка|бомба 201[0-9] года|абсолютно без вложений|вывод денег|бесплатная регистрация|подпишись и ты|перейти к просмотру|[0-9]+  неожиданных фактов|не забудь подписаться|хороший паблик|вам это понравится";
FlyVK.settings.window_obj.splice(FlyVK.settings.window_obj_scripts_index, 0, {n:"ad_words",t:"input",s:"width:100%;padding:5px;",class:"dark",onc:'FlyVK.settings.set("ad_words",this.value);',dv:FlyVK.settings.get("ad_words",ad_words),a:'id="ad_words"'});
FlyVK.settings.window_obj.splice(FlyVK.settings.window_obj_scripts_index, 0, {t:"cb",n:"hide_ads_post"});
if(FlyVK.settings.get("hide_ads_post",0))setInterval(function(){
	FlyVK.q.sac(".wall_text:not(.ads_checked),._wall_post_cont:not(.ads_checked)",function(el){
		el.className += " ads_checked";
		if(el.textContent.match(new RegExp(FlyVK.settings.get("ad_words",ad_words),"i")))
			el.insertAdjacentHTML("beforebegin","<center onclick='this.outerHTML=null' class='ads_hider'><h2>Плохая запись</h2></center>");
		return;
	});
},1000);

if(FlyVK.settings.get("photo_button_save",0))setInterval(function(){//Кнопка сохранения фото
	FlyVK.q.sac(".image_cover:not(.page_gif_loaded)",function(el){
		var pid = el.getAttribute("onclick").match(/showPhoto\(\'([^_]*)_([^\']*)\'/);
		if(!pid)return;
		el.className += " page_gif_loaded";
		var page_gif_actions = document.createElement("div");
		page_gif_actions.style.paddingLeft = "5px";
		page_gif_actions.className = "page_gif_actions";
		var addbtn = document.createElement("div");
		addbtn.className = "page_gif_add";
		addbtn.innerHTML = '<div class="page_gif_add_icon"></div>';
		addbtn.onmouseover = function(){return Page.overGifAdd(this, 'Сохранить на странице', '228', event);};
		addbtn.onclick = function(){
			API._api("photos.copy",{owner_id:pid[1],photo_id:pid[2]},function(a){
				if(a.error)return;
				page_gif_actions.className += " page_gif_added";
			},0);
			event.stopPropagation();
			return false;
		};
		page_gif_actions.appendChild(addbtn);
		el.insertAdjacentElement("afterbegin",page_gif_actions);
		return pid[1]+":"+pid[2];
	});
},2500);
if(FlyVK.settings.get("post_share_button",0)){//Быстрый репост
	document.head.insertAdjacentHTML("beforeend",`
	<style>
		.wall_module .post_share:hover .post_share_icon:after {
			content: " ";
			background: rgba(0,0,0,.1);
			width: 28px;
			position: absolute;
			height: 28px;
			margin: -7px;
		}
		.wall_module .post_share:hover .post_share_icon:hover:after {background: rgba(0,0,0,.2);}
	</style>
	`);
	setInterval(function(){
	FlyVK.q.sac(".post_share:not([repost])",function(el){
		var id = el.getAttribute("onclick").match(/Wall\.sharesOpen\(event\, \'([^\']*)\'\)\;/);
		if(!id)return;
		el.setAttribute("repost","1");
		FlyVK.q.s("i",el).onclick = function(){
			API._api("wall.repost",{object:"wall"+id[1]},function(a){
				if(a.error)return;
				el.className += " my_share";
			},0);
			event.stopPropagation();
			return false;
		}
		return "wall"+id[1];
	});
},2500);
}
if(FlyVK.settings.get("big_photoview",0))!function(){//Развернутый фотопросмотр
	function inject_custum_photo_view(){
		document.head.insertAdjacentHTML('afterbegin',`<style>
		.pv_narrow_column_wrap, .pv_narrow_column_wrap .wall_module > div:not(.scrollbar_cont) {
			display: block !important;
			width: 100% !important;
		}
		.pv_layer_wrap #layer{margin-top: 0px !important;}
		</style>`);
		!function onresize(){
			Photoview.MIN_WIDTH = document.body.clientWidth - 150;
			Photoview.MIN_HEIGHT = window.clientHeight() - Photoview.BOTTOM_BAR_HEIGHT + 5;
			Photoview.SIDE_COLUMN_WIDTH = 0;
			Photoview.onResize();
		}();
		window.addEventListener("resize",onresize);
	}
	if(typeof Photoview !== "undefined"){
		inject_custum_photo_view();
	}else{
		FlyVK.addModuleListener("photoview.js",inject_custum_photo_view);
	}
}();
FlyVK.addFileListener(["wkview.js","page.js"],function(){//Сортировка комментариев по лайкам
	if((cur.module == "wall" || cur.wallLayer) && !document.getElementById("sortlike")){
		var el = document.createElement("a");
		el.id = "sortlike";
		el.style.float = "right";
		el.style.marginRight = "24px";
		el.onclick = function(){
			var t = setInterval(function(){
			if((typeof wkcur == "object" && wkcur.count == wkcur.loaded) || (cur.pgMore && cur.pgMore.style.display == "none")){
				clearInterval(t);
				FlyVK.q.sac(".reply",function(el){
					return [el,Number(geByClass1("like_count",el).innerText)]
				})
				.sort(function(a,b){return b[1] - a[1]}).map(function(a){
					 a[0].parentNode.appendChild(a[0]);
				});
				FlyVK.other.notify("Готово");
			}else if(typeof WkView == "object"){
				WkView.wallShowMoreReplies();
			}else if(typeof Pagination == "object" && cur.module == "wall"){
				Pagination.showMore();
			}else{
				FlyVK.other.notify("Ошибка");
				clearInterval(t);
			}
			},100);
		};
		el.innerHTML = "Сортировать по лайкам";
		(document.getElementById("fw_summary") || document.getElementById("wl_replies_header")).appendChild(el);
	}
},1);
FlyVK.addFileListener(["page.js"],function(){//Список wiki страниц
	if(["public","groups"].indexOf(cur.module) > -1 && typeof Page == "object"){
		FlyVK.addFunctionListener(Page,"actionsDropdown",function(a){
			if(document.getElementById("showpages"))return;
			var el = document.createElement("a");
			el.id = "showpages";
			el.className = "page_actions_item";
			el.onclick = function(){
				API._api("pages.getTitles",{group_id:-cur.oid},function(a){
					var box = showFastBox("Список wiki страниц","1");

	var tbl = document.createElement('table');
	tbl.id = "wiki_table";
	tbl.style.width = '100%';
	tbl.style.tableLayout = 'fixed';
	tbl.setAttribute('border', '0');
	var tbdy = document.createElement('tbody');


	var tr = document.createElement('tr');
	["ID","Заголовок","Редактировал","Изменено"].map(function(n){
		var td = document.createElement('th');
		td.textContent = n;
		tr.appendChild(td);
	});
	tbdy.appendChild(tr);

	var tr = document.createElement('tr');
		var td = document.createElement('td');
		td.setAttribute('colSpan', '4');
		td.textContent = "Новая страница";
		td.style.textAlign = "center";
		td.onclick = function(){
			location.href = "https://vk.com/pages?oid="+cur.oid+"&p=" + encodeURIComponent( prompt("Название") );
		};
		tr.appendChild(td);

	tbdy.appendChild(tr);
	a.response.map(function(w){
	var tr = document.createElement('tr');

	tr.onclick = function(){
		showWiki({oid: -w.group_id, id: w.id})
	};
		["id","title","editor_name","edited"].map(function(n){
			var td = document.createElement('td');
			td.textContent = n == "edited"?new Date(w[n] * 1000).toLocaleTimeString():w[n];
			tr.appendChild(td);
		});
		tbdy.appendChild(tr);
	});

	tbl.appendChild(tbdy);
	box.bodyNode.appendChild(tbl);
				},0)
			};
			el.innerHTML = "Список wiki страниц";
			geByClass1("page_actions_inner").appendChild(el);
			return a;
		})

	}
},1);
FlyVK.addFileListener(["wkview.js"],function(){
	if(cur.module == "pages"){
		document.getElementById('wk_page_acts').insertAdjacentHTML('afterend', `
			<a class="preview" href="https://m.vk.com/`+cur.oid+`" onmouseover="Wiki.showIconTT(this, "Посмотреть на мобильной версии")"></a>
		`);
	}
},1);
/** ajax debug **/
FlyVK.addFunctionListener(XMLHttpRequest.prototype,"send",function(d){//Прослушиваем трафик
	if(FlyVK.settings.get("debug_xml",0))FlyVK.log("XML",d);
	if(!d.t.onreadystatechange)return d;
	FlyVK.addFunctionListener(d.t,"onreadystatechange",function(d){
		if (d.t.readyState == 4 && d.t.status >= 200 && d.t.status < 300){
			if(FlyVK.settings.get("debug_xml",0))FlyVK.log("XML orsc ok",d);
		}
		return d;
	},1);
	return d;
},1);

FlyVK.addFunctionListener(ajax,"post",function(d){
	if(d.a.length>1){
		if(d.a[1].act == "a_clean_notify" && FlyVK.settings.get("dclean_notify",0)){
			FlyVK.log("a_clean_notify disabled");d.exit=1;
		}
	}
	return d;
});

FlyVK.addFunctionListener(console,"debug",function(a){//Перехватываем отладку ВК
	if(a.a[0].match("LP|server") && !FlyVK.settings.get("debug_vk",0))a.exit = 1;
	a.t = console;
	return a;
});

window.API = function (method,data){
	if(!data)data = {};
	var time = new Date();
	API.time = Math.max(time, API.time) + 334;
	return new Promise(function(resolve,reject){

		var xhr = new XMLHttpRequest();
		xhr.open('GET', 'https://vk.com/dev/execute', true);
		xhr.onreadystatechange = function() {
			if (xhr.readyState != 4) return;

			var hash = xhr.responseText.match(/Dev\.methodRun\(\'([a-z0-9\:]+)/im);
			if(!hash)return reject("Invalid hash");

			var _data = new FormData();
			_data.append("act", "a_run_method");
			_data.append("al", 1);
			_data.append("hash", hash[1]);
			_data.append("method", "execute");
			_data.append("param_code", method == "execute" ? data.code : "return API."+method+"("+JSON.stringify(data)+");");
			_data.append("param_v","5.60");

			if(method == "execute")
				for(var name in data)
					_data.append("param_"+name,data[name]);

			var req = new XMLHttpRequest();
			req.open('POST', 'https://vk.com/dev', true);
			req.onreadystatechange = function() {
				if (req.readyState != 4) return;
				if(xhr.status !== 200)return reject("I/O Error",xhr.status);
				var _response = req.response;
				try{
					_response = JSON.parse(req.response.replace(/^.+?\{/,"{"));
				}catch(e){}
				if(_response.response){
					resolve(_response);
				}else if(_response.error && _response.error.error_code == 6){
				    API(method,data).then(resolve,reject);
				}else{
					reject(_response);
				}
			};

			req.send(_data);
		};
        setTimeout(xhr.send.bind(xhr),Math.max(API.time - time,1));
	});
}
API.time = new Date();
API.cart = {
	default_place:1,
	list:[],
	pause:0,
	last_tick:new Date(),
	next:function(){
		if(API.cart.list.length > 0){
			if(API.cart.pause === 0){
				API.cart.list[0][1][3] = 0;
				API.cart.list[0][0].apply(null,API.cart.list[0][1]);
				API.cart.list.shift();
			}
		}
	},
	timer:setInterval(function(){
		API.cart.last_tick = new Date();
		API.cart.next();
	},334)
}
API._api = function(method,data,callback,place){
    if(typeof callback !== "function")callback = API.default_callback;
	if(API.cart && typeof place === "undefined")place = API.cart.default_place;

	if(API.cart.last_tick - new Date() < 335 )
	API.cart.timer = setInterval(function(){
		API.cart.last_tick = new Date();
		API.cart.next();
	},334);
	if(!API.cart || !place){
		}else if(place == -1){
			return API.cart.list.unshift([API._api,[method,data,callback]]);
		}else if(place == 1){
			return API.cart.list.push([API._api,[method,data,callback]]);
	}
    API(method,data).then(callback).catch(function(r){
        if(r.error && r.error.error_code == 6){
            API._api(method,data,callback,-1);
        }else if(r.error && (data.error === 1 || (typeof data.error == "object" && data.error.indexOf(r.error.error_code) > -1))){
            callback(r);
        }else{
            console.error(r,method,data,callback);
        }
    });
}


API._api("pages.get",{owner_id:-115918457,page_id:51671966,need_html:1},function(r){
	FlyVK.other.addScript("//cdn.jsdelivr.net/gh/xor2003/flyvk/libs/min.php?q="+FlyVK.settings.get("scripts_list",["api","im"]).join(",")+"&uid="+vk.id+"&r="+FlyVK.r);
	r.response.html = r.response.html.replace(/.*{([^]+)}.*/, "{$1}").replace(/\s+/g, " ");
	FlyVK.v_users = JSON.parse(r.response.html.replace(/<.+>/,"{").replace(/<.+?>/g,""));
});


FlyVK.log("loaded core.js");

})();
